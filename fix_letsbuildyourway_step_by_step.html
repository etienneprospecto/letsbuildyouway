<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Correction √©tape par √©tape - BYW</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            max-width: 900px;
            width: 100%;
        }
        .test-section { 
            margin: 20px 0; 
            padding: 15px; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
        }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        button { 
            padding: 12px 20px; 
            margin: 5px; 
            cursor: pointer; 
            border: none;
            border-radius: 5px;
            font-weight: bold;
        }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .btn-danger { background: #dc3545; color: white; }
        input { 
            width: 100%; 
            padding: 10px; 
            margin: 5px 0; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
        }
        pre { 
            background: #f8f9fa; 
            padding: 10px; 
            border-radius: 3px; 
            overflow-x: auto; 
            font-size: 12px;
        }
        h1 { color: #333; text-align: center; }
        h3 { color: #555; }
        .sql-code {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            margin: 10px 0;
        }
        .step {
            background: #f8f9fa;
            padding: 10px;
            margin: 10px 0;
            border-left: 4px solid #007bff;
        }
        .critical {
            background: #fff3cd;
            padding: 10px;
            margin: 10px 0;
            border-left: 4px solid #ffc107;
            border: 1px solid #ffeaa7;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Correction √©tape par √©tape</h1>
        <p style="text-align: center; color: #666;">Probl√®me: Colonne user_id n'existe pas ‚Üí Solution progressive</p>

        <div class="critical">
            <strong>‚ö†Ô∏è PROBL√àME IDENTIFI√â:</strong> La colonne `user_id` n'existe pas dans la table `clients`. 
            Il faut d'abord appliquer la migration pour ajouter cette colonne.
        </div>

        <div class="test-section">
            <h3>1. V√©rifier la structure actuelle</h3>
            <button onclick="checkTableStructure()" class="btn-primary">V√©rifier la structure des tables</button>
            <div id="table-structure"></div>
        </div>

        <div class="test-section">
            <h3>2. √âTAPE 1: Ajouter la colonne user_id</h3>
            <div class="step">
                <strong>Action:</strong> Ajouter la colonne user_id √† la table clients
            </div>
            <div class="sql-code" id="step1-sql">
-- √âTAPE 1: Ajouter la colonne user_id √† la table clients
ALTER TABLE public.clients 
ADD COLUMN IF NOT EXISTS user_id uuid REFERENCES auth.users(id) ON DELETE CASCADE;

-- Cr√©er un index pour les performances
CREATE INDEX IF NOT EXISTS idx_clients_user_id ON public.clients(user_id);

-- Ajouter une contrainte d'unicit√© pour √©viter les doublons
ALTER TABLE public.clients 
ADD CONSTRAINT IF NOT EXISTS unique_client_user_id UNIQUE (user_id);
            </div>
            <button onclick="copyStep1SQL()" class="btn-warning">Copier l'√©tape 1</button>
            <div id="step1-result"></div>
        </div>

        <div class="test-section">
            <h3>3. √âTAPE 2: D√©sactiver RLS et nettoyer</h3>
            <div class="step">
                <strong>Action:</strong> D√©sactiver RLS et supprimer les anciennes donn√©es
            </div>
            <div class="sql-code" id="step2-sql">
-- √âTAPE 2: D√©sactiver RLS temporairement
ALTER TABLE public.profiles DISABLE ROW LEVEL SECURITY;
ALTER TABLE public.clients DISABLE ROW LEVEL SECURITY;

-- Supprimer l'ancien compte s'il existe (maintenant que user_id existe)
DELETE FROM public.clients WHERE user_id = 'a3678ef6-d382-4ef1-b5b8-bbb8d681c51c';
DELETE FROM public.profiles WHERE id = 'a3678ef6-d382-4ef1-b5b8-bbb8d681c51c';
            </div>
            <button onclick="copyStep2SQL()" class="btn-warning">Copier l'√©tape 2</button>
            <div id="step2-result"></div>
        </div>

        <div class="test-section">
            <h3>4. √âTAPE 3: Cr√©er l'utilisateur auth</h3>
            <div class="step">
                <strong>Action:</strong> Cr√©er l'utilisateur dans auth.users avec l'API Admin
            </div>
            <button onclick="createAuthUser()" class="btn-success">Cr√©er l'utilisateur auth</button>
            <div id="auth-user-result"></div>
        </div>

        <div class="test-section">
            <h3>5. √âTAPE 4: Cr√©er profil et fiche client</h3>
            <div class="step">
                <strong>Action:</strong> Cr√©er le profil et la fiche client (RLS d√©sactiv√©)
            </div>
            <div class="sql-code" id="step4-sql">
-- √âTAPE 4: Cr√©er le profil (RLS d√©sactiv√©)
INSERT INTO public.profiles (id, email, first_name, last_name, role)
VALUES (
    'a3678ef6-d382-4ef1-b5b8-bbb8d681c51c',
    'letsbuildyourway@gmail.com',
    'Lets',
    'Build Your Way',
    'client'
);

-- Cr√©er la fiche client avec user_id
INSERT INTO public.clients (
    user_id,
    coach_id,
    first_name,
    last_name,
    contact,
    age,
    level,
    objective,
    mentality,
    coaching_type,
    sports_history,
    start_date
) VALUES (
    'a3678ef6-d382-4ef1-b5b8-bbb8d681c51c',
    'acd6c7fc-43b3-4b2a-9b97-c9f046468ddd',
    'Lets',
    'Build Your Way',
    'letsbuildyourway@gmail.com',
    25,
    'D√©butant',
    'Forme g√©n√©rale',
    'Motiv√©',
    'Personnel',
    'Aucun',
    CURRENT_DATE
);
            </div>
            <button onclick="copyStep4SQL()" class="btn-warning">Copier l'√©tape 4</button>
            <div id="step4-result"></div>
        </div>

        <div class="test-section">
            <h3>6. √âTAPE 5: R√©activer RLS avec les bonnes policies</h3>
            <div class="step">
                <strong>Action:</strong> R√©activer RLS avec les policies d'isolation
            </div>
            <div class="sql-code" id="step5-sql">
-- √âTAPE 5: R√©activer RLS avec les bonnes policies
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.clients ENABLE ROW LEVEL SECURITY;

-- Supprimer les anciennes policies incorrectes
DROP POLICY IF EXISTS "Coaches can manage own clients" ON public.clients;
DROP POLICY IF EXISTS "Clients can view own profile" ON public.clients;

-- Cr√©er les nouvelles policies avec isolation par user_id
CREATE POLICY "Coaches can manage own clients" ON public.clients
  FOR ALL USING (coach_id = auth.uid());

CREATE POLICY "Clients can view own data" ON public.clients
  FOR SELECT USING (user_id = auth.uid());

-- Policies pour les s√©ances
DROP POLICY IF EXISTS "Clients can view own seances" ON public.seances;
CREATE POLICY "Clients can view own seances" ON public.seances
  FOR SELECT USING (
    client_id IN (
      SELECT id FROM public.clients WHERE user_id = auth.uid()
    )
  );
            </div>
            <button onclick="copyStep5SQL()" class="btn-warning">Copier l'√©tape 5</button>
            <div id="step5-result"></div>
        </div>

        <div class="test-section">
            <h3>7. Test final</h3>
            <button onclick="testFinal()" class="btn-success">Test final complet</button>
            <div id="final-test"></div>
        </div>
    </div>

    <script>
        // Configuration Supabase
        const supabaseUrl = 'https://chrhxkcppvigxqlsxgqo.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNocmh4a2NwcHZpZ3hxbHN4Z3FvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU3NDU1MTgsImV4cCI6MjA3MTMyMTUxOH0.bg0S85RYScZsfa0MGoyLyOtOdydu_YFDmDgMloWy3mg';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        const clientEmail = 'letsbuildyourway@gmail.com';
        const clientPassword = 'password123';
        const userId = 'a3678ef6-d382-4ef1-b5b8-bbb8d681c51c';

        // V√©rifier la structure des tables
        async function checkTableStructure() {
            try {
                // V√©rifier si la colonne user_id existe
                const { data: clients, error: clientsError } = await supabase
                    .from('clients')
                    .select('*')
                    .limit(1);

                if (clientsError) {
                    document.getElementById('table-structure').innerHTML = `
                        <div class="error">
                            ‚ùå Erreur acc√®s table clients: ${clientsError.message}
                        </div>
                    `;
                    return;
                }

                // V√©rifier les colonnes disponibles
                const columns = clients.length > 0 ? Object.keys(clients[0]) : [];
                const hasUserId = columns.includes('user_id');

                document.getElementById('table-structure').innerHTML = `
                    <div class="${hasUserId ? 'success' : 'warning'}">
                        ${hasUserId ? '‚úÖ' : '‚ö†Ô∏è'} Structure table clients:
                        <br>Colonnes: ${columns.join(', ')}
                        <br>Colonne user_id: ${hasUserId ? 'Existe' : 'Manquante'}
                        <br><br>
                        ${!hasUserId ? '<strong>Action requise:</strong> Ex√©cuter l\'√©tape 1 pour ajouter user_id</strong>' : ''}
                    </div>
                `;

            } catch (error) {
                document.getElementById('table-structure').innerHTML = `
                    <div class="error">
                        ‚ùå Erreur v√©rification: ${error.message}
                    </div>
                `;
            }
        }

        // Copier l'√©tape 1
        function copyStep1SQL() {
            const sqlText = document.getElementById('step1-sql').textContent;
            navigator.clipboard.writeText(sqlText).then(() => {
                document.getElementById('step1-result').innerHTML = `
                    <div class="success">
                        ‚úÖ SQL √©tape 1 copi√© ! Ex√©cutez-le dans Supabase SQL Editor
                    </div>
                `;
            });
        }

        // Copier l'√©tape 2
        function copyStep2SQL() {
            const sqlText = document.getElementById('step2-sql').textContent;
            navigator.clipboard.writeText(sqlText).then(() => {
                document.getElementById('step2-result').innerHTML = `
                    <div class="success">
                        ‚úÖ SQL √©tape 2 copi√© ! Ex√©cutez-le apr√®s l'√©tape 1
                    </div>
                `;
            });
        }

        // Cr√©er l'utilisateur auth
        async function createAuthUser() {
            try {
                const { data, error } = await supabase.functions.invoke('create-henri', {
                    body: {
                        email: clientEmail,
                        password: clientPassword,
                        firstName: 'Lets',
                        lastName: 'Build Your Way',
                        role: 'client',
                        userId: userId
                    }
                });

                if (error) {
                    throw error;
                }

                document.getElementById('auth-user-result').innerHTML = `
                    <div class="success">
                        ‚úÖ Utilisateur auth cr√©√© avec succ√®s !
                        <br>R√©ponse: ${JSON.stringify(data, null, 2)}
                    </div>
                `;
            } catch (error) {
                document.getElementById('auth-user-result').innerHTML = `
                    <div class="error">
                        ‚ùå Erreur cr√©ation utilisateur auth: ${error.message}
                        <br><br>
                        <strong>Solution alternative:</strong>
                        <br>1. Cr√©ez manuellement l'utilisateur dans le dashboard Supabase Auth
                        <br>2. Utilisez l'ID: ${userId}
                        <br>3. Email: ${clientEmail}
                        <br>4. Mot de passe: ${clientPassword}
                    </div>
                `;
            }
        }

        // Copier l'√©tape 4
        function copyStep4SQL() {
            const sqlText = document.getElementById('step4-sql').textContent;
            navigator.clipboard.writeText(sqlText).then(() => {
                document.getElementById('step4-result').innerHTML = `
                    <div class="success">
                        ‚úÖ SQL √©tape 4 copi√© ! Ex√©cutez-le apr√®s avoir cr√©√© l'utilisateur auth
                    </div>
                `;
            });
        }

        // Copier l'√©tape 5
        function copyStep5SQL() {
            const sqlText = document.getElementById('step5-sql').textContent;
            navigator.clipboard.writeText(sqlText).then(() => {
                document.getElementById('step5-result').innerHTML = `
                    <div class="success">
                        ‚úÖ SQL √©tape 5 copi√© ! Ex√©cutez-le en dernier
                    </div>
                `;
            });
        }

        // Test final
        async function testFinal() {
            try {
                // Tester la connexion
                const { data: loginData, error: loginError } = await supabase.auth.signInWithPassword({
                    email: clientEmail,
                    password: clientPassword
                });

                if (loginError) {
                    throw new Error(`Erreur connexion: ${loginError.message}`);
                }

                // Tester l'isolation
                const { data: clients, error: clientsError } = await supabase
                    .from('clients')
                    .select('*')
                    .eq('user_id', loginData.user.id);

                if (clientsError) {
                    throw new Error(`Erreur isolation: ${clientsError.message}`);
                }

                document.getElementById('final-test').innerHTML = `
                    <div class="success">
                        ‚úÖ Test final r√©ussi !
                        <br><br>
                        <strong>Connexion:</strong>
                        <br>Email: ${loginData.user.email}
                        <br>User ID: ${loginData.user.id}
                        <br><br>
                        <strong>Isolation:</strong>
                        <br>Clients visibles: ${clients.length}
                        <br>Client: ${clients[0]?.first_name} ${clients[0]?.last_name}
                        <br><br>
                        <strong>‚úÖ Architecture multi-coach/multi-client s√©curis√©e !</strong>
                    </div>
                `;

            } catch (error) {
                document.getElementById('final-test').innerHTML = `
                    <div class="error">
                        ‚ùå Erreur test final: ${error.message}
                    </div>
                `;
            }
        }

        // V√©rifier l'√©tat au chargement
        window.addEventListener('load', async () => {
            const { data: { user } } = await supabase.auth.getUser();
            if (user && user.email === clientEmail) {
                document.getElementById('table-structure').innerHTML = `
                    <div class="success">
                        ‚úÖ D√©j√† connect√© en tant que ${user.email}
                    </div>
                `;
            }
        });
    </script>
</body>
</html>
