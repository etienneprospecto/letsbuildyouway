<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Auth - BYW</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1f2937, #000000, #1f2937);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            color: white;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(31, 41, 55, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid #374151;
            border-radius: 12px;
            padding: 40px;
        }
        .log {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #4b5563;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        button {
            background: linear-gradient(135deg, #fa7315, #ea580c);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            margin: 10px 5px;
            cursor: pointer;
            font-weight: 600;
        }
        button:hover {
            background: linear-gradient(135deg, #ea580c, #fa7315);
        }
        .success { color: #22c55e; }
        .error { color: #ef4444; }
        .warning { color: #f59e0b; }
        .info { color: #3b82f6; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Debug Authentication BYW</h1>
        
        <div>
            <button onclick="checkAuth()">1. V√©rifier l'auth actuelle</button>
            <button onclick="login()">2. Se connecter</button>
            <button onclick="checkProfile()">3. V√©rifier le profil</button>
            <button onclick="testDashboard()">4. Tester le dashboard</button>
            <button onclick="clearLog()">5. Effacer les logs</button>
        </div>
        
        <div id="log" class="log">Cliquez sur "V√©rifier l'auth actuelle" pour commencer...</div>
    </div>

    <script>
        const supabaseUrl = 'https://chrhxkcppvigxqlsxgqo.supabase.co'
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNocmh4a2NwcHZpZ3hxbHN4Z3FvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU3NDU1MTgsImV4cCI6MjA3MTMyMTUxOH0.bg0S85RYScZsfa0MGoyLyOtOdydu_YFDmDgMloWy3mg'
        
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey)
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log')
            const timestamp = new Date().toLocaleTimeString()
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info'
            logDiv.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`
            logDiv.scrollTop = logDiv.scrollHeight
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = ''
        }
        
        async function checkAuth() {
            log('üîç V√©rification de l\'authentification actuelle...', 'info')
            
            try {
                const { data: { user }, error: userError } = await supabase.auth.getUser()
                
                if (userError) {
                    log(`‚ùå Erreur getUser: ${userError.message}`, 'error')
                    return
                }
                
                if (!user) {
                    log('‚ùå Aucun utilisateur connect√©', 'warning')
                    return
                }
                
                log(`‚úÖ Utilisateur connect√©:`, 'success')
                log(`   - Email: ${user.email}`, 'info')
                log(`   - ID: ${user.id}`, 'info')
                log(`   - Email confirm√©: ${user.email_confirmed_at ? 'Oui' : 'Non'}`, 'info')
                log(`   - R√¥le (metadata): ${user.user_metadata?.role || 'Non d√©fini'}`, 'info')
                log(`   - Cr√©√© le: ${new Date(user.created_at).toLocaleString()}`, 'info')
                
                // V√©rifier la session
                const { data: { session }, error: sessionError } = await supabase.auth.getSession()
                
                if (sessionError) {
                    log(`‚ùå Erreur getSession: ${sessionError.message}`, 'error')
                } else if (session) {
                    log(`‚úÖ Session active:`, 'success')
                    log(`   - Access token: ${session.access_token.substring(0, 20)}...`, 'info')
                    log(`   - Expires at: ${new Date(session.expires_at * 1000).toLocaleString()}`, 'info')
                } else {
                    log('‚ùå Aucune session active', 'warning')
                }
                
            } catch (error) {
                log(`‚ùå Erreur: ${error.message}`, 'error')
            }
        }
        
        async function login() {
            const email = 'team@propulseo-site.com'
            const password = prompt('Entrez le mot de passe pour team@propulseo-site.com:')
            
            if (!password) {
                log('‚ùå Mot de passe requis', 'error')
                return
            }
            
            log(`üîê Tentative de connexion avec ${email}...`, 'info')
            
            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email,
                    password
                })
                
                if (error) {
                    log(`‚ùå Erreur de connexion: ${error.message}`, 'error')
                    return
                }
                
                if (data.user) {
                    log(`‚úÖ Connexion r√©ussie!`, 'success')
                    log(`   - Email: ${data.user.email}`, 'info')
                    log(`   - ID: ${data.user.id}`, 'info')
                    log(`   - Session: ${data.session ? 'Active' : 'Inactive'}`, 'info')
                }
                
            } catch (error) {
                log(`‚ùå Erreur: ${error.message}`, 'error')
            }
        }
        
        async function checkProfile() {
            log('üë§ V√©rification du profil...', 'info')
            
            try {
                const { data: profile, error } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('email', 'team@propulseo-site.com')
                    .single()
                
                if (error) {
                    log(`‚ùå Erreur profil: ${error.message}`, 'error')
                    return
                }
                
                if (!profile) {
                    log('‚ùå Profil non trouv√©', 'error')
                    return
                }
                
                log(`‚úÖ Profil trouv√©:`, 'success')
                log(`   - ID: ${profile.id}`, 'info')
                log(`   - Email: ${profile.email}`, 'info')
                log(`   - R√¥le: ${profile.role}`, 'info')
                log(`   - Plan: ${profile.subscription_plan || 'Non d√©fini'}`, 'info')
                log(`   - Statut: ${profile.subscription_status || 'Non d√©fini'}`, 'info')
                log(`   - Pr√©nom: ${profile.first_name || 'Non d√©fini'}`, 'info')
                log(`   - Nom: ${profile.last_name || 'Non d√©fini'}`, 'info')
                
            } catch (error) {
                log(`‚ùå Erreur: ${error.message}`, 'error')
            }
        }
        
        async function testDashboard() {
            log('üè† Test d\'acc√®s au dashboard...', 'info')
            
            try {
                // Simuler une requ√™te vers l'API de l'app
                const response = await fetch('http://localhost:5173/app/dashboard', {
                    method: 'GET',
                    credentials: 'include'
                })
                
                log(`üì° R√©ponse du dashboard: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error')
                
                if (response.ok) {
                    log('‚úÖ Dashboard accessible!', 'success')
                } else {
                    const text = await response.text()
                    log(`‚ùå Erreur dashboard: ${text.substring(0, 200)}...`, 'error')
                }
                
            } catch (error) {
                log(`‚ùå Erreur r√©seau: ${error.message}`, 'error')
            }
        }
        
        // Auto-v√©rification au chargement
        window.onload = () => {
            log('üöÄ Debug Auth BYW d√©marr√©', 'info')
            checkAuth()
        }
    </script>
</body>
</html>
